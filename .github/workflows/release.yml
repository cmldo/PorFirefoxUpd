name: Release

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag for the release (leave empty to use latest)'
        required: false

jobs:
  release:
    runs-on: windows-2025

    steps:
      # 1️⃣ Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0 # needed to push tags

      # 2️⃣ Set up MSBuild
      - name: Set up MSBuild
        uses: microsoft/setup-msbuild@v1

      # 3️⃣ Configure Git
      - name: Configure Git
        shell: pwsh
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

      # 4️⃣ Determine tag to use
      - name: Determine tag
        id: tag
        shell: pwsh
        run: |
          $inputTag = '${{ github.event.inputs.tag }}'.Trim()
          if (-not $inputTag) {
              Write-Host "No tag input provided. Using latest Git tag..."
              $latestTag = git describe --tags --abbrev=0 2>$null
              if (-not $latestTag) {
                  Write-Host "No tags found, using 'v0.0.1' as default"
                  $TAG = "v0.0.1"
              } else {
                  $TAG = $latestTag
              }
          } else {
              $TAG = $inputTag
          }
          Write-Host "Using tag: $TAG"
          echo "TAG=$TAG" >> $env:GITHUB_ENV

      # 5️⃣ Check and create tag if missing
      - name: Check and create tag
        shell: pwsh
        run: |
          $TAG = $env:TAG
          Write-Host "Checking if tag '$TAG' exists..."
          $exists = git show-ref --tags $TAG
          if ($exists) {
              Write-Host "Tag '$TAG' already exists"
          } else {
              Write-Host "Tag '$TAG' does not exist. Creating it..."
              git tag "$TAG"
              git push origin "$TAG"
          }

      # 6️⃣ Build the solution (auto-detect .sln)
      - name: Build project
        shell: pwsh
        run: |
          Write-Host "Searching for solution file..."
          $solutionFiles = Get-ChildItem -Path $PWD -Recurse -Filter "*.sln"
          if ($solutionFiles.Count -eq 0) {
              Write-Error "No solution file found in repository"
              exit 1
          } elseif ($solutionFiles.Count -gt 1) {
              Write-Host "Multiple solution files found, using first:"
              $solutionFiles | ForEach-Object { Write-Host $_.FullName }
          }
          $solutionPath = $solutionFiles[0].FullName
          Write-Host "Building solution: $solutionPath"
          msbuild "$solutionPath" /p:Configuration=Release

      # 7️⃣ Prepare publish folder with correct exe name
      - name: Prepare publish folder
        shell: pwsh
        run: |
          $publishDir = Join-Path $PWD "publish"
          if (Test-Path $publishDir) { Remove-Item $publishDir -Recurse -Force }
          New-Item -ItemType Directory -Path $publishDir

          # Copy only the exe matching AssemblyName
          $exeName = "Portable Firefox Updater.exe"
          $exePath = Get-ChildItem -Path $PWD -Recurse -File -Filter $exeName | Select-Object -First 1
          if (-not $exePath) { Write-Error "Build output $exeName not found"; exit 1 }

          Copy-Item -Path $exePath.FullName -Destination $publishDir -Force
          Write-Host "Copied $exeName to publish folder"

      # 8️⃣ Create GitHub Release
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.TAG }}
          name: Release ${{ env.TAG }}
          files: publish/**
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
